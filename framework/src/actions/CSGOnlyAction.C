//* This file is part of the MOOSE framework
//* https://www.mooseframework.org
//*
//* All rights reserved, see COPYRIGHT for full restrictions
//* https://github.com/idaholab/moose/blob/master/COPYRIGHT
//*
//* Licensed under LGPL 2.1, please see LICENSE for details
//* https://www.gnu.org/licenses/lgpl-2.1.html

#include "MooseApp.h"
#include "CSGOnlyAction.h"
#include "CSGBase.h"
#include "MeshGenerator.h"

registerMooseAction("MooseApp", CSGOnlyAction, "csg_only");
registerMooseAction("MooseApp", CSGOnlyAction, "setup_mesh");
registerMooseAction("MooseApp", CSGOnlyAction, "execute_csg_generators");

InputParameters
CSGOnlyAction::validParams()
{
  return Action::validParams();
}

CSGOnlyAction::CSGOnlyAction(const InputParameters & params) : Action(params) {}

void
CSGOnlyAction::act()
{
  if (_current_task == "setup_mesh")
  {
    if (!_mesh)
      mooseError("Cannot generate CSG object without a [Mesh] block in the input file");
    _app.getMeshGeneratorSystem().setCSGOnly();
  }
  else if (_current_task == "execute_csg_generators")
  {
    const auto final_mg_name = _app.getMeshGeneratorSystem().getFinalMeshGeneratorName();
    const auto ordered_mg = _app.getMeshGeneratorSystem().getOrderedMeshGenerators();

    for (const auto & generator_set : ordered_mg)
      for (const auto & generator : generator_set)
      {
        auto csg_obj = generator->generateInternalCSG();
        const auto & name = generator->name();
        // If we are running generateCSG for final generator, store CSG object for use in csg_only
        // task
        if (name == final_mg_name)
        {
          _csg_obj = std::move(csg_obj);
          return;
        }
        else
        {
          // Store CSG object created by mesh generator for use by downstream MG's
          _app.getMeshGeneratorSystem().saveOutputCSGBase(name, csg_obj);
        }
      }
  }
  else if (_current_task == "csg_only")
  {
    const auto final_mg_name = _app.getMeshGeneratorSystem().getFinalMeshGeneratorName();
    if (!_csg_obj)
      mooseError("Expecting final generator with name " + final_mg_name +
                 " but not found in mesh generator tree");

    Moose::out << "Outputting CSGBase object for " + final_mg_name + "\n";

    auto csg_json = _csg_obj->generateOutput();

    // write generated json to file. Filename will be based on optional argument to
    // --csg-only. If not provided, the output name will be based on the filename
    std::string json_out = _app.parameters().get<std::string>("csg_only");
    if (json_out.empty())
      json_out = _app.getOutputFileBase() + "_csg.json";

    std::ofstream csg_file;
    csg_file.open(json_out);
    csg_file << csg_json.dump(/*indent=*/2);
    csg_file.close();
  }
}
