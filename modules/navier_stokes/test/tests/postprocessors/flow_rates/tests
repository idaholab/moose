[Tests]
  design = 'VolumetricFlowRate.md'
  issues = '#16169 #16585'
  [fe]
    type = CSVDiff
    input = conservation_INSFE.i
    csvdiff = straight_INSFE.csv
    abs_zero = 1e-8
    requirement = 'The system shall be able to compute mass and momentum flow rates at internal and external boundaries of a straight channel with a finite element incompressible Navier Stokes model.'
    cli_args = "Mesh/inactive='diverging_mesh' Outputs/file_base='straight_INSFE'"
  []
  [fe_diverging]
    type = CSVDiff
    input = conservation_INSFE.i
    csvdiff =  diverging_INSFE.csv
    abs_zero = 1e-8
    requirement = 'The system shall be able to compute mass and momentum flow rates at internal and external boundaries of a diverging channel with a finite element incompressible Navier Stokes model.'
    cli_args = "Outputs/file_base='diverging_INSFE'"
  []
  [insfv_straight]
    type = CSVDiff
    input = conservation_INSFV.i
    csvdiff =  straight_INSFV.csv
    abs_zero = 1e-8
    requirement = 'The system shall be able to compute flow rates and prove mass, momentum and energy conservation at internal and external boundaries of a frictionless heated straight channel with a finite volume incompressible Navier Stokes model.'
    cli_args = "Mesh/inactive='diverging_mesh' Outputs/file_base='straight_INSFV' -pc_type lu -pc_factor_shift_type NONZERO"
    ad_indexing_type = 'global'
  []
  [insfv_diverging]
    requirement = 'The system shall be able to compute flow rates and prove mass, momentum and energy conservation at internal and external boundaries of a frictionless heated diverging channel with a finite volume incompressible Navier Stokes model,'
    [insfv_quad_xy]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_quad_xy.csv
      abs_zero = 1e-8
      detail = 'with a quadrilateral mesh in XY geometry, with mass flow measured using either a variable or material property,'
      ad_indexing_type = 'global'
      cli_args = "Outputs/file_base='diverging_INSFV_quad_xy'"
    []
    [insfv_quad_rz]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_quad_rz.csv
      abs_zero = 1e-8
      detail = 'with a quadrilateral mesh in RZ geometry,'
      cli_args = "Problem/coord_type=RZ Outputs/file_base='diverging_INSFV_quad_rz'"
      ad_indexing_type = 'global'
    []
    [insfv_tri_xy]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_tri_xy.csv
      abs_zero = 1e-8
      detail = 'with a triangular mesh in XY geometry,'
      cli_args = "Mesh/diverging_mesh/file='expansion_tri.e' Outputs/file_base='diverging_INSFV_tri_xy' GlobalParams/two_term_boundary_expansion=false"
      ad_indexing_type = 'global'
    []
    [insfv_quad_xy_upwind]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_quad_xy_upwind.csv
      abs_zero = 1e-8
      detail = 'with upwind interpolation of advected quantities,'
      cli_args = "advected_interp_method='upwind' Outputs/file_base='diverging_INSFV_quad_xy_upwind' Postprocessors/inactive='inlet_momentum_x inlet_momentum_y'"
      ad_indexing_type = 'global'
    []
    [insfv_quad_xy_noslip]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_quad_xy_noslip.csv
      abs_zero = 1e-8
      detail = 'with no-slip boundary conditions, for which momentum and energy will be dissipated at the wall.'
      cli_args = "FVBCs/inactive='free-slip-u free-slip-v' Outputs/file_base='diverging_INSFV_quad_xy_noslip'"
      ad_indexing_type = 'global'
    []
    [insfv_quad_xy_noslip_refined]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_quad_xy_noslip.csv
      abs_zero = 1e-8
      detail = 'with uniform refinement near an internal interface.'
      cli_args = "-r 1 FVBCs/inactive='free-slip-u free-slip-v' Outputs/file_base='diverging_INSFV_quad_xy_noslip'"
      ad_indexing_type = 'global'
    []
    [initial]
      type = CSVDiff
      input = conservation_INSFV.i
      csvdiff = diverging_INSFV_initial.csv
      abs_zero = 1e-8
      detail = 'at the very beginning of the simulation, with the initialized velocities'
      cli_args = "Variables/temperature/initial_condition=290 UserObjects/rc/execute_on='INITIAL PRE_KERNELS' UserObjects/rc/force_preaux=true Postprocessors/inlet_mass_variable/execute_on=initial Postprocessors/inlet_mass_constant/execute_on=initial Postprocessors/inlet_mass_matprop/execute_on=initial Postprocessors/mid1_mass/execute_on=INITIAL Postprocessors/outlet_mass/execute_on=INITIAL Postprocessors/mid1_advected_energy/execute_on=INITIAL Postprocessors/mid2_advected_energy/execute_on=INITIAL Outputs/file_base=diverging_INSFV_initial"
      ad_indexing_type = 'global'
    []
  []
  [pinsfv_straight]
    type = CSVDiff
    input = conservation_PINSFV.i
    csvdiff =  straight_PINSFV.csv
    abs_zero = 1e-8
    requirement = 'The system shall be able to compute flow rates and prove mass, momentum and energy conservation at internal and external boundaries of a frictionless heated straight channel with a finite volume porous media incompressible Navier Stokes model.'
    cli_args = "Mesh/inactive='diverging_mesh' Outputs/file_base='straight_PINSFV'"
    ad_indexing_type = 'global'
  []
  [pinsfv_diverging]
    requirement = 'The system shall be able to compute flow rates and prove mass, momentum and energy conservation at internal and external boundaries of a frictionless heated diverging channel with a finite volume porous media incompressible Navier Stokes model,'
    [pinsfv_quad_xy]
      type = CSVDiff
      input = conservation_PINSFV.i
      csvdiff = diverging_PINSFV_quad_xy.csv
      abs_zero = 1e-8
      detail = 'with a quadrilateral mesh in XY geometry, with mass flow measured using either a variable or material property,'
      ad_indexing_type = 'global'
      cli_args = "Outputs/file_base='diverging_PINSFV_quad_xy'"
    []
    [pinsfv_quad_rz]
      type = CSVDiff
      input = conservation_PINSFV.i
      csvdiff = diverging_PINSFV_quad_rz.csv
      abs_zero = 1e-8
      detail = 'with a quadrilateral mesh in RZ geometry,'
      cli_args = "Problem/coord_type=RZ Outputs/file_base='diverging_PINSFV_quad_rz'"
      ad_indexing_type = 'global'
    []
    [pinsfv_quad_xy_upwind]
      type = CSVDiff
      input = conservation_PINSFV.i
      csvdiff = diverging_PINSFV_quad_xy_upwind.csv
      abs_zero = 1e-8
      detail = 'with upwind interpolation of advected quantities,'
      cli_args = "advected_interp_method='upwind' Outputs/file_base='diverging_PINSFV_quad_xy_upwind' Postprocessors/inactive='inlet_momentum_x inlet_momentum_y'"
      ad_indexing_type = 'global'
    []
    [pinsfv_quad_xy_noslip]
      type = CSVDiff
      input = conservation_PINSFV.i
      csvdiff = diverging_PINSFV_quad_xy_noslip.csv
      abs_zero = 1e-8
      detail = 'and with no-slip boundary conditions, for which momentum and energy will be dissipated at the wall.'
      cli_args = "FVBCs/inactive='free-slip-u free-slip-v' Outputs/file_base='diverging_PINSFV_quad_xy_noslip'"
      ad_indexing_type = 'global'
    []
  []
  [warnings]
    requirement = 'The system shall issue a warning if'
    [fv_preaux]
      type = RunException
      input = conservation_INSFV.i
      cli_args = 'UserObjects/rc/force_preaux=true UserObjects/rc/a_u=0 UserObjects/rc/a_v=0'
      expect_err = 'Executing the Rhie Chow user object before auxkernels is only valid if the auxvariables involved are constant'
      detail = 'Rhie Chow interpolation is used, with auxiliary variables for the coefficients, and the user object has been set to execute before auxkernels'
      ad_indexing_type = 'global'
    []
  []
  [errors]
    requirement = 'The system shall error if'
    [initial_vfr_only]
      type = RunException
      input = conservation_INSFV.i
      cli_args = 'Postprocessors/mid1_mass/execute_on=INITIAL'
      expect_err = 'The Rhie Chow user object must be executed before the VolumetricFlowRate postprocessor'
      detail = 'using finite volume discretization, a volumetric flow rate is requested at the beginning of the simulation and the interpolation coefficients are not computed yet'
      ad_indexing_type = 'global'
    []
  []
[]