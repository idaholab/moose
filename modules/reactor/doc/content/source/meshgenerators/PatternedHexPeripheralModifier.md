# PatternedHexPeripheralModifier

!syntax description /Mesh/PatternedHexPeripheralModifier

## Overview

This `PatternedHexPeripheralModifier` class utilizes [`FillBetweenPointVectorsTools`](/FillBetweenPointVectorsTools.md) to replace the outmost layer of the quad elements of the 2D hexagonal assembly mesh generated by [`PatternedHexMeshGenerator`](PatternedHexMeshGenerator.md) (or its derived class [`HexIDPatternedMeshGenerator`](HexIDPatternedMeshGenerator.md)) with a transition layer consisting of triangular elements so that the assembly mesh can have nodes on designated positions on the external boundary. This boundary modification facilitates the stitching of hexagonal assemblies which have different node numbers on their outer periphery due to differing numbers of interior pins and/or different azimuthal discretization.

##  Default Behavior of `PatternedHexMeshGenerator` and the Least Common Multiple Approach

When [`PatternedHexMeshGenerator`](PatternedHexMeshGenerator.md) is used to generate a hexagonal assembly mesh, the number of nodes on each hexagon side follows a pre-determined formula based on the pin cell meshes which comprise the assembly. These pin cell hexagonal meshes used by [`PatternedHexMeshGenerator`](PatternedHexMeshGenerator.md) must have a uniform even number of sectors per side (e.g., $2M$) given by [!param](/Mesh/PolygonConcentricCircleMeshGenerator/num_sectors_per_side) in [`PolygonConcentricCircleMeshGenerator`](/PolygonConcentricCircleMeshGenerator.md). If [`PatternedHexMeshGenerator`](PatternedHexMeshGenerator.md) creates a hexagonal bundle with $N$ ($N>1$) pins on each side of the outermost ring, there are $2M\cdot(2N-1)$ sectors or $2M\cdot(2N-1)+1$ nodes on each side of the hexagonal assembly mesh. If all the assemblies within a reactor core contain identical numbers of pins, it is straightforward to make assembly meshes stitchable with each other by using the same $M$ number for the azimuthal discretization of each pin cell. However, if a reactor core includes assemblies with different numbers of pins, $M$ must be wisely selected based on the least common multiple of $4N_i-2$ ($i$ is the assembly index) of all the assemblies involved. This approach may be practical in cases where two assembly types with different pin numbers are involved, as shown in the following table:

| Assm. #1 Number of pins per side $N_1$ | Assm. #1 Number of azimuthal intervals per sector $M_1$  | Assm. #1 Number of pins per side $N_2$ | Assm. #1 Number of azimuthal intervals per sector $M_2$ | Node Number on Assembly Side |
| --- | --- | --- | --- | --- |
| 2 | 5 | 3 | 3 | 30 |
| 2 | 7 | 4 | 3 | 42 |
| 2 | 3 | 5 | 1 | 18 |
| 2 | 11 | 6 | 3 | 66 |
| 2 | 13 | 7 | 3 | 78 |
| 3 | 7 | 4 | 5 | 70 |
| 3 | 9 | 5 | 5 | 90 |
| 3 | 11 | 6 | 5 | 110 |
| 3 | 13 | 7 | 5 | 130 |
| 4 | 9 | 5 | 7 | 126 |
| 4 | 11 | 6 | 7 | 154 |
| 4 | 13 | 7 | 7 | 182 |
| 5 | 11 | 6 | 9 | 198 |
| 5 | 13 | 7 | 9 | 234 |
| 6 | 13 | 7 | 11 | 286 |

However, multiple different assemblies with unique numbers of pins are involved in a reactor core, the [!param](/Mesh/PolygonConcentricCircleMeshGenerator/num_sectors_per_side) (i.e., $2M$) may be impractically large, as indicated in the following table:

| Assm. #1 $N_1$ | Assm. #1 $M_1$  | Assm. #2 $N_2$ |  Assm. #2 $M_2$ | Assm. #3 $N_3$ |  Assm. #3 $M_3$ | Node Number on Assembly Side |
| --- | --- | --- | --- | --- | --- | --- |
| 2 | 35 | 3 | 21 | 4 | 15 | 210 |
| 2 | 15 | 3 | 9 | 5 | 5 | 90 |
| 2 | 55 | 3 | 33 | 6 | 15 | 330 |
| 2 | 21 | 4 | 9 | 5 | 7 | 126 |
| 2 | 77 | 4 | 33 | 6 | 21 | 462 |
| 2 | 33 | 5 | 11 | 6 | 9 | 198 |
| 3 | 63 | 4 | 45 | 5 | 35 | 630 |
| 3 | 77 | 4 | 55 | 6 | 35 | 770 |
| 3 | 99 | 5 | 55 | 6 | 45 | 990 |
| 4 | 99 | 5 | 77 | 6 | 63 | 1386 |

## Modification of Peripheral Boundary to Allow Stitching

The `PatternedHexPeripheralModifier` class modifies assembly meshes so that assemblies with different number of pins can be stitched together without increasing the mesh fidelity to an impractically fine fidelity (as shown in the previous section). This mesh generator only works with the [!param](/Mesh/PatternedHexPeripheralModifier/input) mesh created by [`PatternedHexMeshGenerator`](PatternedHexMeshGenerator.md). Users must specify the external boundary of the input assembly mesh through [!param](/Mesh/PatternedHexPeripheralModifier/input_mesh_external_boundary). Given this input, the mesh generator identifies and deletes the outmost layer of elements and uses the newly formed external boundary as one of the two vectors of boundary nodes needed by [`FillBetweenPointVectorsTools`](/FillBetweenPointVectorsTools.md) after symmetry reduction. In addition, uniformly distributed nodes are placed along the original external boundary of the mesh and defined as the second vector of boundary nodes needed by [`FillBetweenPointVectorsTools`](/FillBetweenPointVectorsTools.md). The number of new boundary nodes is specified using [!param](/Mesh/PatternedHexPeripheralModifier/new_num_sector). Thus, the outmost layer of the assembly mesh can be replaced with a triangular element transition layer mesh that can be easily stitched with another transition layer mesh. An example of the assembly mesh modified by this mesh generator is shown in [Figure 1](#assembly_example)

!media reactor/meshgenerators/peripheral_mod.png
      style=display: block;margin-left:auto;margin-right:auto;width:60%;
      id=assembly_example
      caption=A schematic drawing of an example assembly mesh with transition layer as its outmost mesh layer.

## Advantages

This mesh generator forces the number of nodes on a hexagonal mesh to match a user-specified input. This allows assemblies with different number of pins or azimuthal discretizations (and consequently different numbers of boundary nodes) to be stitched together without increasing the mesh density to an unreasonable level.

!media reactor/meshgenerators/patterned_peripheral_mesh.png
      style=display: block;margin-left:auto;margin-right:auto;width:60%;
      id=pattern_adv
      caption=A schematic drawing showing a virtual core design with assemblies including 7, 19, 37 and 61 pins.

[Figure 2](#pattern_adv) illustrates a core comprising four types of assemblies. This mesh generator's functionality was leveraged to force a common mesh density on each hexagonal assembly side (16 nodes on each assembly side) so that the assemblies can be easily stitched. In the absence of this mesh generator, the least common multiple approach would require 631 nodes on each assembly side as shown in [Figure 3](#compare). The mesh density would be increased dramatically just to ensure stitchability, showing the prominent advantage of using this mesh generator instead of the least common multiple approach.

!media reactor/meshgenerators/compare.png
      style=display: block;margin-left:auto;margin-right:auto;width:80%;
      id=compare
      caption=A close-up comparison between the virtual core meshes (see [Figure 2](#pattern_adv)) generated with and without using this mesh generator.

## Handling Reporting IDs

If the input mesh contains extra element integers (reporting IDs), the `PatternedHexPeripheralModifier` provides options to retain or reassign these reporting IDs (see [Figure 4](#reporting_id_example)). By default, all the extra element integers existing on the input mesh are retained. Due to the nature of the transition layer which creates a new set of elements, the original boundaries between different reporting ID values have to be slightly shifted after modification. When `PatternedHexPeripheralModifier` assigns reporting ID values to a new element in the transition layer, it utilizes the reporting ID values of the original element that is nearest to the new element (based on centroid positions) to retain the setting of the input mesh.

!alert note
The extra element IDs from the original peripheral region are conserved. They may be modified using the [!param](/Mesh/PatternedHexPeripheralModifier/extra_id_names_to_modify) and [!param](/Mesh/PatternedHexPeripheralModifier/new_extra_id_values_to_assign) parameters.

!media reactor/meshgenerators/peripheral_modifier_reporting_id.png
      style=display: block;margin-left:auto;margin-right:auto;width:95%;
      id=reporting_id_example
      caption=Different approaches to handle a reporting id: (Left) input mesh with reporting id (pin_id); (Middle) retained pin_id for transition layer; (Right) user provided pin_id value for transition layer.

## Example Syntax

!listing modules/reactor/test/tests/meshgenerators/patterned_hex_peripheral_modifier/patterned.i block=Mesh/pmg_1

!syntax parameters /Mesh/PatternedHexPeripheralModifier

!syntax inputs /Mesh/PatternedHexPeripheralModifier

!syntax children /Mesh/PatternedHexPeripheralModifier
