{#- Required jinja arguments                                                                  -#}
{#- MOOSE_DIR: Path on the host to the MOOSE repository                                       -#}

{#- MOOSE_JOBS: Number of jobs to pass to the builds                                          -#}
{#- Optional jinja arguments                                                                  -#}
{#- ALTERNATE_FROM: Set an alternate from (currently supported: clang, clang_min, gcc_min)    -#}

{#- The files directory for this definition                                                   -#}
{%- set FILES_DIR = MOOSE_DIR + '/apptainer/files/mpi' -%}

Bootstrap: docker
{%- if ALTERNATE_FROM == "clang" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-clang20.1.8-mpich5.0.0_0
{%- elif ALTERNATE_FROM == "clang_min" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-clang14.0.6-mpich5.0.0_0
{%- elif ALTERNATE_FROM == "cuda" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-cuda12.9.1-gcc13.3.1-mpich5.0.0-openmpi5.0.9
{%- elif ALTERNATE_FROM == "gcc_min" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-gcc9.2.1-mpich5.0.0_0
{%- elif ALTERNATE_FROM == "intel" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-oneapi2025.3.2-mpich5.0.0_0
{%- elif ALTERNATE_FROM == "rocky9" %}
From: ghcr.io/idaholab/moose-mpibase/rocky:9.7-gcc13.3.1-mpich4.3.2-openmpi5.0.9_0
{%- else %}
From: ghcr.io/idaholab/moose-mpibase/rocky:8.10-gcc13.3.1-mpich5.0.0-openmpi5.0.9_0
{%- endif %}

%environment
    # Fix locale warnings
    export LC_ALL=C

    source /moose_env.sh

%post
    umask 022

    # Determine rocky version
    grep -q "Rocky" /etc/os-release && IS_ROCKY=1
    if [ -n "$IS_ROCKY" ]; then
        grep 'VERSION=\"8.' /etc/os-release && IS_ROCKY_8=1
        grep 'VERSION=\"9.' /etc/os-release && IS_ROCKY_9=1
    fi

    # Remove apptainer if it's installed
    if dnf list installed apptainer &> /dev/null; then
        dnf remove -y apptainer
    fi

    # Enable additional repos
    dnf install -y dnf-plugins-core
    if [ -n "$IS_ROCKY_8" ]; then
        dnf config-manager --set-enabled powertools
        dnf install -y redhat-lsb-core.x86_64
    elif [ -n "$IS_ROCKY_9" ]; then
        dnf config-manager --set-enabled crb
        dnf install -y epel-release
    fi

    # Additional installs
    dnf install -y emacs make cmake diffutils bison flex perl-IO-Compress perl-JSON \
        perl-JSON-PP libtirpc libtirpc-devel zlib-devel patch patchutils libpng \
        libpng-devel valgrind cppunit doxygen fftw-devel gsl-devel libtool autoconf \
        automake cppunit-devel glpk-devel patchelf lcov bash-completion

    # Clean after install
    dnf clean all

%test
    if [ -n "$MOOSE_MPICH_DIR" ]; then
        ${MOOSE_MPICH_DIR}/bin/mpiexec --version
    fi
    if [ -n "$MOOSE_OPENMPI_DIR" ]; then
        ${MOOSE_OPENMPI_DIR}/bin/mpiexec --version
        ${MOOSE_OPENMPI_DIR}/bin/ompi_info
    fi

%files
    {{ FILES_DIR }}/.singularity.d/env/02-fix-actions.sh /.singularity.d/env/02-fix-actions.sh
    {{ FILES_DIR }}/.singularity.d/moose_bashrc /.singularity.d/moose_bashrc
